# 小游戏功能说明（基于腾讯云 IM）

> 本文档用于 **前后端统一理解** 小游戏功能的整体设计、核心流程与技术选型。
>
> 当前一期目标：**支持多人实时文字类小游戏（默认：狼人杀）**，保证稳定、可扩展、可上线。

---

## 一、整体目标

我们需要在现有系统中新增一个 **小游戏模块**，具备以下能力：

- 多人实时在线
- 房间制 / 群组制
- 私密信息下发（如狼人身份）
- 公共消息广播（投票结果、阶段变化）
- 稳定性高，适配微信小程序环境

### 技术选型

- **实时通信**：腾讯云 IM（即时通信）
- **业务逻辑**：自有后端（HTTP API）
- **前端**：微信小程序（uni-app）

> ❗不直接使用 WebSocket 承载实时逻辑，避免小程序端不稳定问题

---

## 二、整体架构

```
┌────────────┐        HTTP        ┌──────────────┐
│  小程序端   │  ─────────────▶  │   自有后端    │
│ (uni-app)  │                   │  (游戏逻辑)  │
└─────┬──────┘                   └─────┬────────┘
      │   IM SDK                             │
      │（群聊 / 私聊）                      │
      ▼                                     ▼
┌─────────────────────────────────────────────┐
│                腾讯云 IM                      │
│  群消息 / C2C 消息 / 在线状态 / 成员管理      │
└─────────────────────────────────────────────┘
```

---

## 三、生命周期说明（前端视角）

### 1️⃣ 进入小游戏页面

- 前端调用后端接口获取 `UserSig`
- 使用 IM SDK 登录（login）

> 登录时机：**进入小游戏页面**

---

### 2️⃣ 大厅（房间列表）

进入小游戏大厅后：

- 拉取已有房间列表（IM 群组列表 or 后端房间列表）
- 支持以下操作：
  - 创建房间
  - 加入房间
  - 搜索房间加入

> 一个房间 = 一个 IM 群组

#### 推荐的后端接口（MVP）

- `GET /game/rooms`：获取房间列表（后端通过 IM `get_appid_group_list` 拉取群组列表）
- `POST /game/rooms`：创建房间（后端通过 IM `create_group` 创建群组）

> 这样前端无需直接调用腾讯云 REST API，只需拿到 `groupId` 并监听群消息即可。

---

### 3️⃣ 创建 / 加入房间

- 创建房间：
  - 后端创建 IM 群组
  - 设置房主（Owner）

- 加入房间（推荐走后端，保证业务校验一致）：
  - `POST /game/rooms/{groupId}/join`：后端把当前用户加入对应 IM 群组

- 加入房间：
  - 加入对应 IM 群组

进入房间后：
- 监听群消息
- 展示房间成员列表

---

### 4️⃣ 准备阶段

房间内状态：

- 每个玩家有一个 `准备 / 未准备` 状态
- 玩家点击「准备」后：
  - 方案 A（推荐，后端权威）：前端调用 `POST /game/rooms/{groupId}/ready`，后端记录 ready 并通过 IM 群消息广播 `READY`
  - 方案 B：前端直接发群消息（type: READY），后端不做 ready 校验（不推荐）

房主能力：
- 当 **所有玩家准备完成**
- 房主可点击「开始游戏」

---

## 四、游戏流程（狼人杀示例）

### 1️⃣ 游戏开始

- 房主点击开始
- 后端执行：
  - 生成本局游戏状态
  - 分配每个玩家身份（狼人 / 平民等）

MVP 接口：`POST /game/rooms/{groupId}/start`

#### 身份下发（关键）

- 后端 → 使用 **IM 私聊（C2C）**
- 每个玩家只收到自己的身份
- 其他人无法得知

MVP 私聊消息格式（TIMCustomElem.Data 为 JSON 字符串）：

```json
{
  "type": "ROLE",
  "payload": {
    "groupId": "@TGS#...",
    "startedAt": 1760000000,
    "role": "WOLF",
    "wolves": ["1001", "1002"]
  }
}
```

---

### 2️⃣ 游戏回合流程（简化版）

每一轮包含以下阶段（可逐步扩展）：

1. 白天阶段
2. 投票阶段
3. 结果公布

---

### 3️⃣ 投票机制设计

- 仅 **存活玩家** 可投票
- 投票触发规则：
  - **第一个存活玩家点击投票按钮 → 投票阶段开始**

#### 投票流程

1. 玩家点击投票（或弃票）
2. 前端 → 后端 HTTP 上报投票
3. 后端记录投票状态
4. 后端通过 **群消息**广播投票进度

MVP 接口：`POST /game/rooms/{groupId}/vote`

群消息格式示例：

```json
{"type":"VOTE_PROGRESS","payload":{"votedCount":2,"totalAlive":6,"finished":false}}
```

结果广播：

```json
{"type":"VOTE_RESULT","payload":{"groupId":"@TGS#...","eliminated":"1003"}}
```

> 若出现平票或全弃票，`eliminated` 可能为 null。

#### 投票结束条件

- 所有存活玩家均完成投票 / 弃票

---

### 4️⃣ 公布结果

- 后端计算投票结果
- 后端通过 **IM 群消息**广播：
  - 被淘汰玩家
  - 当前存活名单

进入下一轮 / 游戏结束

---

## 五、退出与资源释放

### 退出小游戏页面

- 前端执行：
  - IM logout
  - 取消所有监听

> ❗退出页面即退出 IM，避免后台连接残留

---

## 六、前后端职责划分（非常重要）

### 前端（小程序）

- IM 登录 / 登出
- 群消息 & 私聊消息监听
- UI 状态渲染
- 用户操作上报（准备 / 投票等）

❌ 不维护核心游戏状态

---

### 后端（游戏服务器）

- UserSig 生成
- 房间 & 游戏状态管理
- 身份分配（权威）
- 投票计算
- 通过 IM 下发消息

✅ 所有关键逻辑以后端为准

---

## 七、后续可扩展方向

- 多游戏类型（不同房间支持不同游戏）
- 语音狼人杀（IM 语音）
- 观战模式
- 战绩 / 结算系统

---

## 八、一期 MVP 范围（建议）

- 文字版狼人杀
- 固定人数（如 6 人）
- 简化流程（无技能）

> 目标：**先跑通一整局游戏**

---

## 九、总结

- 腾讯云 IM 负责：**实时通信 & 成员同步**
- 自有后端负责：**游戏规则 & 状态一致性**
- 小程序只做：**UI + 事件转发**

这是一个：
> ✅ 稳定
> ✅ 易扩展
> ✅ 可上线

的小游戏架构方案。

